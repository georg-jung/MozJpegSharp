parameters:
- name: appendNativeLibPath
  type: boolean
  default: false
- name: 'dependsOn'
  type: object
  default: []


stages:
- stage: Test
  displayName: Build and Test
  dependsOn:
  - ${{ if parameters.dependsOn }}:
    - ${{ parameters.dependsOn }}
  jobs:
  - job: test_windows
    pool:
      vmImage: 'windows-latest'
    steps:
    - template: ../steps/build.yml
    - ${{ if eq(parameters.appendNativeLibPath, true) }}:
      - script: |
          echo ##vso[task.prependpath]$(System.ArtifactsDirectory)\mozjpeg\win-x64\bin\
        displayName: Append native lib dir to path
    - template: ../steps/test.yml

  - job: test_macos
    pool:
      vmImage: 'macOS-10.15'
    variables:
      RID: osx-x64
    steps:
    - script: |
        brew install mono-libgdiplus
      displayName: Install libgdiplus
    - template: ../steps/build.yml
    - ${{ if eq(parameters.appendNativeLibPath, true) }}:
      - script: |
          echo '##vso[task.setvariable variable=LD_LIBRARY_PATH]${LD_LIBRARY_PATH}:$(System.ArtifactsDirectory)/mozjpeg/$(RID)/lib/'
        displayName: Append native lib dir to path
    - template: ../steps/test.yml

  - job: test_ubuntu_16_04
    variables:
      RID: linux-x64
    pool:
      vmImage: 'ubuntu-16.04'
    container:
      image: mcr.microsoft.com/dotnet/core/sdk:3.1-bionic
      options: "--name ci-container -v /usr/bin/docker:/tmp/docker:ro"
    steps:
    - script: |
        /tmp/docker exec -t -u 0 ci-container \
        sh -c "apt-get update && DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confold" -y install sudo"
      displayName: Set up sudo
    - script: |
        sudo add-apt-repository ppa:quamotion/ppa
        sudo apt-get update
        sudo apt-get install -y libc6-dev libgdiplus libcurl4
      displayName: Install libgdiplus, libcurl
    - template: ../steps/build.yml
    - ${{ if eq(parameters.appendNativeLibPath, true) }}:
      - script: |
          echo '##vso[task.setvariable variable=LD_LIBRARY_PATH]$LD_LIBRARY_PATH:$(System.ArtifactsDirectory)/mozjpeg/$(RID)/lib/'
        displayName: Append native lib dir to path
    - template: ../steps/test.yml

  - job: test_centos_7
    variables:
      RID: linux-x64
    pool:
      vmImage: 'ubuntu-16.04'
    container:
      image: centos:7
      options: "--name ci-container -v /usr/bin/docker:/tmp/docker:ro"
    steps:
    - script: |
        /tmp/docker exec -t -u 0 ci-container \
        sh -c "yum install -y sudo"
      displayName: Set up sudo
    - script: |
        sudo rpm -Uvh https://packages.microsoft.com/config/centos/7/packages-microsoft-prod.rpm
        # Work around https://github.com/dotnet/core/issues/3853
        sudo yum install -y https://packages.microsoft.com/centos/7/prod/netstandard-targeting-pack-2.1.0-x64.rpm
        sudo yum install -y dotnet-sdk-3.1
      displayName: Install .NET 3.1 SDK
    - script: |
        sudo yum-config-manager -y --add-repo https://download.opensuse.org/repositories/home:/qmfrederik/CentOS_7/home:qmfrederik.repo
        sudo yum install -y libgdiplus
      displayName: Install libgdiplus
    - template: ../steps/build.yml
    - ${{ if eq(parameters.appendNativeLibPath, true) }}:
      - script: |
          echo '##vso[task.setvariable variable=LD_LIBRARY_PATH]$LD_LIBRARY_PATH:$(System.ArtifactsDirectory)/mozjpeg/$(RID)/lib/'
        displayName: Append native lib dir to path
    - template: ../steps/test.yml
