stages:
- stage: BuildNativeLibs
  displayName: Build Native Libraries
  jobs:
  - job: build_nativelib_windows
    strategy:
      maxParallel: 2
      matrix:
        x64:
          BUILD_ARCH: x64
          PLATFORM: x64
          RID: win-x64
        x86:
          BUILD_ARCH: x86
          PLATFORM: Win32
          RID: win-x86
    pool:
      vmImage: 'vs2017-win2016'
    steps:
    - checkout: none
    - script: |
        %VCPKG_INSTALLATION_ROOT%\vcpkg version
        %VCPKG_INSTALLATION_ROOT%\vcpkg integrate install
        set VCPKG_BUILD_TYPE=release
        %VCPKG_INSTALLATION_ROOT%\vcpkg install mozjpeg:%BUILD_ARCH%-windows
      displayName: Install native dependencies
    - script: |
        mkdir %BUILD_ARTIFACTSTAGINGDIRECTORY%\mozjpeg\%RID%\bin\
        copy %VCPKG_INSTALLATION_ROOT%\installed\%BUILD_ARCH%-windows\tools\mozjpeg\*jpeg*.dll %BUILD_ARTIFACTSTAGINGDIRECTORY%\mozjpeg\%RID%\bin\
        copy %VCPKG_INSTALLATION_ROOT%\installed\%BUILD_ARCH%-windows\share\mozjpeg\copyright %BUILD_ARTIFACTSTAGINGDIRECTORY%\mozjpeg\%RID%\bin\mozjpeg.copyright
      displayName: 'Install'
    - task: PublishBuildArtifacts@1
      inputs:
        pathtoPublish: '$(Build.ArtifactStagingDirectory)/mozjpeg/'
        artifactName: 'mozjpeg'
        publishLocation: 'Container'
      displayName: Publish

  - job: build_nativelib_macos
    pool:
      vmImage: 'macOS-10.14'
    variables:
      TARGET: x86_64-apple-darwin
      RID: osx-x64
    steps:
    - checkout: none
    - script: |
        brew install autoconf automake libtool pkg-config nasm
      displayName: Install autotools, nasm
    - script: |
        wget https://github.com/mozilla/mozjpeg/archive/${MOZJPEG_VERSION_IDENTIFIER}.tar.gz -O mozjpeg-${MOZJPEG_VERSION}.tar.gz
        tar xvf mozjpeg-${MOZJPEG_VERSION}.tar.gz
      displayName: Download sources
    - script: |
        cd mozjpeg-${MOZJPEG_VERSION}
        autoreconf -fiv
        cd ..
        sh mozjpeg-${MOZJPEG_VERSION}/configure --prefix=${BUILD_ARTIFACTSTAGINGDIRECTORY}/mozjpeg/$RID --host=$TARGET
        make
      displayName: Build
    - script: |
        make install
      displayName: Install
    - task: PublishBuildArtifacts@1
      inputs:
        pathtoPublish: '$(Build.ArtifactStagingDirectory)/mozjpeg'
        artifactName: 'mozjpeg'
        publishLocation: 'Container'
      displayName: Publish

  - job: build_nativelib_ubuntu
    pool:
      vmImage: ubuntu-16.04
    variables:
      RID: linux-x64
    steps:
    - checkout: none
    - script: |
        sudo apt install autoconf automake libtool pkg-config nasm
      displayName: Install autotools, nasm
    - script: |
        wget https://github.com/mozilla/mozjpeg/archive/${MOZJPEG_VERSION_IDENTIFIER}.tar.gz -O mozjpeg-${MOZJPEG_VERSION}.tar.gz
        tar xvf mozjpeg-${MOZJPEG_VERSION}.tar.gz
      displayName: Download sources
    - script: |
        cd mozjpeg-${MOZJPEG_VERSION}
        autoreconf -fiv
        cd ..
        sh mozjpeg-${MOZJPEG_VERSION}/configure --prefix=${BUILD_ARTIFACTSTAGINGDIRECTORY}/mozjpeg/$RID
        make
      displayName: Build
    - script: |
        make install
      displayName: Install
    - task: PublishBuildArtifacts@1
      inputs:
        pathtoPublish: '$(Build.ArtifactStagingDirectory)/mozjpeg'
        artifactName: 'mozjpeg'
        publishLocation: 'Container'
      displayName: Publish
